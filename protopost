#!/usr/bin/env bash

MAINCMD="$0"
PROTOPOST_DIR="$(dirname $MAINCMD)"
EXECNAME="$(basename $MAINCMD)"

# Function to check if daemon subcommand has --fork flag
has_daemon_fork() {
    local found_daemon=false
    local has_fork=false
    
    # Parse through all arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --config)
                # Skip config option and its value
                shift 2
                ;;
            daemon)
                found_daemon=true
                shift
                ;;
            --fork)
                if [[ "$found_daemon" == true ]]; then
                    has_fork=true
                fi
                shift
                ;;
            --port)
                # Skip port option and its value
                shift 2
                ;;
            *)
                # note that this case includes arguments like
                #   --config=/my/config.properties
                # so only a single shift occurs with this
                # style of argument, which is right.
                shift
                ;;
        esac
    done
    
    [[ "$found_daemon" == true && "$has_fork" == true ]]
}

cd "$PROTOPOST_DIR"

if [[ "$EXECNAME" == "protopost" ]]; then
    if has_daemon_fork "$@"; then
        ./mill --no-server --ticker=false runDaemon "$@"
    else
        ./mill --no-server --ticker=false run "$@"
    fi
else
    echo "Expected this command to be 'protopost'."
fi



